<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFP 요구사항 뷰어 및 편집기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .req-card { transition: all 0.2s; }
        .req-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <!-- 헤더 -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 sticky top-0 z-50">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">RFP 요구사항 뷰어</h1>
                        <p class="text-sm text-gray-600 mt-1">총 <span id="totalCount" class="font-bold text-blue-600">0</span>개 요구사항 | 필터링 결과: <span id="filteredCount" class="font-bold text-green-600">0</span>개 | 잠금: <span id="lockedCount" class="font-bold text-yellow-600">0</span>개</p>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <select id="jsonFileSelect" onchange="loadSelectedJson()" class="px-4 py-2 bg-white border-2 border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50 shadow-sm font-medium">
                            <option value="">📁 JSON 파일 선택...</option>
                        </select>
                        <button onclick="loadJsonFileList()" class="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 shadow-sm" title="파일 목록 새로고침">
                            🔄
                        </button>
                        <button onclick="loadJsonFile()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm">
                            💾 로컬 파일
                        </button>
                        <input id="jsonFileInput" type="file" accept=".json" class="hidden" />
                        <button onclick="addNewRequirement()" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow-sm">
                            ➕ 요구사항 추가
                        </button>
                        <button onclick="exportToJSON()" class="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 shadow-sm">
                            💾 JSON 저장
                        </button>
                        <button onclick="exportToExcel()" class="flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 shadow-sm">
                            📊 Excel 내보내기
                        </button>
                    </div>
                </div>

                <!-- 필터 바 -->
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 border border-gray-200 rounded-lg p-4">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">기능ID</label>
                            <input id="filterFunctionId" type="text" placeholder="F-001"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">서비스 분야</label>
                            <select id="filterServiceArea"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="">전체</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">서비스 중분류</label>
                            <select id="filterServiceCategory"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="">전체</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">요구사항 분류</label>
                            <select id="filterReqType"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="">전체</option>
                                <option value="기능요구사항(FR)">기능요구사항(FR)</option>
                                <option value="데이터요구사항(DR)">데이터요구사항(DR)</option>
                                <option value="성능요구사항(PR)">성능요구사항(PR)</option>
                                <option value="보안요구사항(SR)">보안요구사항(SR)</option>
                                <option value="품질요구사항(QR)">품질요구사항(QR)</option>
                                <option value="인터페이스요구사항(IR)">인터페이스요구사항(IR)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">검색</label>
                            <input id="filterSearch" type="text" placeholder="기능명, 내용 검색"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                        </div>
                    </div>
                    <div class="mt-3 flex justify-between items-center">
                        <button onclick="resetFilters()" class="text-sm text-gray-600 hover:text-gray-900 underline">
                            필터 초기화
                        </button>
                        <div class="flex gap-2">
                            <label class="flex items-center gap-2 text-sm">
                                <input type="checkbox" id="showOnlyAI" class="rounded" />
                                <span>AI 생성만 보기</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm">
                                <input type="checkbox" id="showOnlyLocked" class="rounded" />
                                <span>잠긴 항목만 보기</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm">
                                <input type="checkbox" id="showOnlyUnlocked" class="rounded" />
                                <span>안 잠김 항목만 보기</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 요구사항 목록 -->
            <div id="requirements-list" class="space-y-4"></div>

            <!-- 로딩 상태 -->
            <div id="loading" class="hidden text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                <p class="mt-4 text-gray-600">데이터를 불러오는 중...</p>
            </div>

            <!-- 빈 상태 -->
            <div id="empty-state" class="hidden text-center py-12 bg-white rounded-lg shadow-sm">
                <p class="text-xl text-gray-600 mb-4">📋 요구사항이 없습니다</p>
                <button onclick="loadJsonFile()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    JSON 파일 불러오기
                </button>
            </div>
        </div>
    </div>

    <script>
        let requirements = [];
        let originalData = [];
        let lockedRequirements = new Set(); // 잠긴 요구사항 인덱스 저장

        // 잠금 상태 복원
        function restoreLockState(data) {
            lockedRequirements = new Set();
            data.forEach((req, index) => {
                if (req.locked === true) {
                    lockedRequirements.add(index);
                }
            });
        }

        // GitHub에서 JSON 파일 목록 가져오기
        async function loadJsonFileList() {
            const select = document.getElementById('jsonFileSelect');
            
            try {
                // GitHub API를 사용하여 저장소의 파일 목록 가져오기
                const response = await fetch('https://api.github.com/repos/jinbless/rfp-viewer/contents/');
                
                if (!response.ok) {
                    console.error('GitHub API 호출 실패, 기본 파일 목록 사용');
                    loadDefaultFileList();
                    return;
                }
                
                const files = await response.json();
                
                // JSON 파일만 필터링
                const jsonFiles = files
                    .filter(file => file.name.endsWith('.json') && file.type === 'file')
                    .sort((a, b) => {
                        // 버전 파일을 먼저, 나머지는 이름순
                        const aIsVersion = a.name.match(/^v\d+\.\d+/);
                        const bIsVersion = b.name.match(/^v\d+\.\d+/);
                        if (aIsVersion && !bIsVersion) return 1;
                        if (!aIsVersion && bIsVersion) return -1;
                        return a.name.localeCompare(b.name);
                    });
                
                // 드롭다운 업데이트
                select.innerHTML = '<option value="">📁 JSON 파일 선택</option>' + 
                    jsonFiles.map(file => {
                        const displayName = getDisplayName(file.name);
                        return `<option value="${file.name}">${displayName}</option>`;
                    }).join('');
                    
                console.log(`✅ ${jsonFiles.length}개의 JSON 파일을 찾았습니다.`);
                
            } catch (error) {
                console.error('JSON 파일 목록 로드 실패:', error);
                loadDefaultFileList();
            }
        }

        // 파일명을 표시용 이름으로 변환
        function getDisplayName(fileName) {
            // 기존 파일들에 대한 매핑
            const nameMap = {
                'RFP_완성본_NFR자동생성.json': '📄 RFP 완성본 (NFR 자동생성)',
                'RFP_완성본_NFR자동생성_fixed.json': '📄 RFP 완성본 (수정본)',
                'RFP_재구조화_결과.json': '📄 RFP 재구조화 결과'
            };
            
            if (nameMap[fileName]) {
                return nameMap[fileName];
            }
            
            // 버전 파일 처리 (예: v1.1_RFP_요구사항_2025-10-14.json)
            const versionMatch = fileName.match(/^(v[\d.]+)_.*(\d{4}-\d{2}-\d{2})\.json$/);
            if (versionMatch) {
                return `📌 ${versionMatch[1]} (${versionMatch[2]})`;
            }
            
            // 기본: 파일명 그대로 표시
            return `📄 ${fileName.replace('.json', '')}`;
        }

        // 기본 파일 목록 (API 실패 시)
        function loadDefaultFileList() {
            const select = document.getElementById('jsonFileSelect');
            select.innerHTML = `
                <option value="">📁 JSON 파일 선택</option>
                <option value="RFP_완성본_NFR자동생성.json">📄 RFP 완성본 (NFR 자동생성)</option>
                <option value="RFP_완성본_NFR자동생성_fixed.json">📄 RFP 완성본 (수정본)</option>
                <option value="RFP_재구조화_결과.json">📄 RFP 재구조화 결과</option>
                <option value="v1.1_RFP_요구사항_2025-10-14.json">📌 v1.1 (2025-10-14)</option>
                <option value="v1.2_RFP_요구사항_2025-10-14.json">📌 v1.2 (2025-10-14)</option>
            `;
        }

        // 데이터 로드
        async function loadDefaultData() {
            try {
                const response = await fetch('RFP_완성본_NFR자동생성.json');
                if (response.ok) {
                    const data = await response.json();
                    requirements = data;
                    originalData = JSON.parse(JSON.stringify(data));
                    restoreLockState(data); // 잠금 상태 복원
                    initializeFilters();
                    renderRequirements();
                }
            } catch (error) {
                console.log('기본 데이터 로드 실패:', error);
            }
        }

        // GitHub에서 선택된 JSON 파일 불러오기
        async function loadSelectedJson() {
            const select = document.getElementById('jsonFileSelect');
            const fileName = select.value;
            
            if (!fileName) return;

            try {
                const response = await fetch(fileName);
                if (!response.ok) throw new Error('파일을 불러올 수 없습니다.');
                
                const data = await response.json();
                requirements = data;
                originalData = JSON.parse(JSON.stringify(data));
                restoreLockState(data); // 잠금 상태 복원
                initializeFilters();
                renderRequirements();
                
                const lockCount = lockedRequirements.size;
                const lockInfo = lockCount > 0 ? ` (잠금: ${lockCount}개)` : '';
                alert(`✅ ${select.options[select.selectedIndex].text} 파일을 성공적으로 불러왔습니다!${lockInfo}`);
            } catch (error) {
                alert('❌ JSON 파일 읽기 실패: ' + error.message);
                select.value = ''; // 선택 초기화
            }
        }

        // 로컬 JSON 파일 불러오기
        function loadJsonFile() {
            document.getElementById('jsonFileInput').click();
        }

        document.getElementById('jsonFileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    requirements = data;
                    originalData = JSON.parse(JSON.stringify(data));
                    restoreLockState(data); // 잠금 상태 복원
                    document.getElementById('jsonFileSelect').value = ''; // 드롭다운 초기화
                    initializeFilters();
                    renderRequirements();
                    
                    const lockCount = lockedRequirements.size;
                    const lockInfo = lockCount > 0 ? ` (잠금: ${lockCount}개)` : '';
                    alert(`✅ 로컬 JSON 파일을 성공적으로 불러왔습니다!${lockInfo}`);
                } catch (error) {
                    alert('❌ JSON 파일 읽기 실패: ' + error.message);
                }
            };
            reader.readAsText(file);
        });

        // 필터 초기화
        function initializeFilters() {
            const serviceAreas = [...new Set(requirements.map(r => r['서비스분야']).filter(Boolean))];
            const serviceCategories = [...new Set(requirements.map(r => r['서비스중분류']).filter(Boolean))];

            const areaSelect = document.getElementById('filterServiceArea');
            areaSelect.innerHTML = '<option value="">전체</option>' +
                serviceAreas.map(a => `<option value="${a}">${a}</option>`).join('');

            const categorySelect = document.getElementById('filterServiceCategory');
            categorySelect.innerHTML = '<option value="">전체</option>' +
                serviceCategories.map(c => `<option value="${c}">${c}</option>`).join('');

            // 필터 이벤트 바인딩
            ['filterFunctionId', 'filterServiceArea', 'filterServiceCategory', 'filterReqType', 'filterSearch', 'showOnlyAI', 'showOnlyLocked', 'showOnlyUnlocked'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener(element.type === 'checkbox' ? 'change' : 'input', renderRequirements);
                }
            });
        }

        // 상위 요구사항 내용 가져오기
        function getParentFunctionName(req) {
            // 1순위: JSON에 직접 저장된 '상위요구사항내용' 사용
            if (req['상위요구사항내용']) {
                return req['상위요구사항내용'];
            }
            
            // 2순위: 상위기능ID로 자동 생성 (하위 호환성)
            if (!req['상위기능ID']) return '';
            
            // 상위기능ID로 요구사항 찾기
            const parentReq = requirements.find(r => r['기능ID'] === req['상위기능ID']);
            
            // 상위 요구사항이 있으면 그 요구사항내용 반환
            if (parentReq && parentReq['요구사항내용']) {
                return parentReq['요구사항내용'];
            }
            
            // 찾지 못하면 빈 값
            return '';
        }

        // 필터링된 요구사항 가져오기
        function getFilteredRequirements() {
            const functionId = document.getElementById('filterFunctionId').value.toLowerCase();
            const serviceArea = document.getElementById('filterServiceArea').value;
            const serviceCategory = document.getElementById('filterServiceCategory').value;
            const reqType = document.getElementById('filterReqType').value;
            const searchText = document.getElementById('filterSearch').value.toLowerCase();
            const showOnlyAI = document.getElementById('showOnlyAI').checked;
            const showOnlyLocked = document.getElementById('showOnlyLocked').checked;
            const showOnlyUnlocked = document.getElementById('showOnlyUnlocked').checked;

            return requirements.filter((req, index) => {
                if (functionId && !String(req['기능ID']).toLowerCase().includes(functionId)) return false;
                if (serviceArea && req['서비스분야'] !== serviceArea) return false;
                if (serviceCategory && req['서비스중분류'] !== serviceCategory) return false;
                if (reqType && req['요구사항분류'] !== reqType) return false;
                if (showOnlyAI && req['비고'] !== 'AI 자동 생성') return false;
                
                // 잠금 상태 필터 (둘 다 체크되면 모두 표시)
                if (showOnlyLocked && !showOnlyUnlocked && !lockedRequirements.has(index)) return false;
                if (showOnlyUnlocked && !showOnlyLocked && lockedRequirements.has(index)) return false;
                
                if (searchText) {
                    const parentFunctionName = getParentFunctionName(req);
                    const searchableText = [
                        req['기능명'],
                        parentFunctionName,
                        req['요구사항내용']
                    ].join(' ').toLowerCase();
                    if (!searchableText.includes(searchText)) return false;
                }
                return true;
            });
        }

        // 요구사항 렌더링
        function renderRequirements() {
            const filtered = getFilteredRequirements();
            const container = document.getElementById('requirements-list');
            const emptyState = document.getElementById('empty-state');

            document.getElementById('totalCount').textContent = requirements.length;
            document.getElementById('filteredCount').textContent = filtered.length;
            document.getElementById('lockedCount').textContent = lockedRequirements.size;

            if (requirements.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 bg-white rounded-lg shadow-sm">
                        <p class="text-xl text-gray-600">🔍 필터 조건에 맞는 요구사항이 없습니다</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map((req, index) => {
                const reqIndex = requirements.indexOf(req);
                const isAI = req['비고'] === 'AI 자동 생성';
                const isLocked = lockedRequirements.has(reqIndex);
                const reqTypeColor = {
                    '기능요구사항(FR)': 'bg-blue-100 text-blue-800',
                    '데이터요구사항(DR)': 'bg-green-100 text-green-800',
                    '성능요구사항(PR)': 'bg-yellow-100 text-yellow-800',
                    '보안요구사항(SR)': 'bg-red-100 text-red-800',
                    '품질요구사항(QR)': 'bg-purple-100 text-purple-800',
                    '인터페이스요구사항(IR)': 'bg-pink-100 text-pink-800',
                }[req['요구사항분류']] || 'bg-gray-100 text-gray-800';

                return `
                    <div class="req-card ${isLocked ? 'bg-gray-100 opacity-75' : 'bg-white'} rounded-lg shadow-sm border-l-4 ${isLocked ? 'border-gray-500' : (isAI ? 'border-purple-500' : 'border-blue-500')}"">
                        <div class="p-6 ${isLocked ? 'relative' : ''}">
                            ${isLocked ? '<div class="absolute top-2 right-2 text-2xl opacity-20">🔒</div>' : ''}
                            <!-- 헤더 -->
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex items-center gap-3 flex-wrap">
                                    <span class="px-3 py-1 bg-gray-800 text-white rounded-full font-bold text-sm">
                                        ${req['기능ID']}
                                    </span>
                                    ${req['상위기능ID'] ? `
                                        <span class="px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs">
                                            ↳ ${req['상위기능ID']}
                                        </span>
                                    ` : ''}
                                    <span class="px-3 py-1 ${reqTypeColor} rounded-full font-semibold text-sm">
                                        ${req['요구사항분류']}
                                    </span>
                                    ${isAI ? `
                                        <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">
                                            🤖 AI 생성
                                        </span>
                                    ` : ''}
                                    ${isLocked ? `
                                        <span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-medium">
                                            🔒 잠김
                                        </span>
                                    ` : ''}
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="toggleLock(${reqIndex})"
                                        class="px-3 py-1 ${isLocked ? 'bg-yellow-50 text-yellow-600 hover:bg-yellow-100' : 'bg-gray-50 text-gray-600 hover:bg-gray-100'} rounded text-sm font-medium">
                                        ${isLocked ? '🔓 잠금해제' : '🔒 잠금'}
                                    </button>
                                    <button onclick="editRequirement(${reqIndex})" ${isLocked ? 'disabled' : ''}
                                        class="px-3 py-1 ${isLocked ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-blue-50 text-blue-600 hover:bg-blue-100'} rounded text-sm font-medium">
                                        ✏️ 수정
                                    </button>
                                    <button onclick="deleteRequirement(${reqIndex})" ${isLocked ? 'disabled' : ''}
                                        class="px-3 py-1 ${isLocked ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-red-50 text-red-600 hover:bg-red-100'} rounded text-sm font-medium">
                                        🗑️ 삭제
                                    </button>
                                </div>
                            </div>

                            <!-- 내용 -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <span class="text-xs font-semibold text-gray-500 uppercase">서비스 분야</span>
                                    <p class="text-sm text-gray-900 mt-1">${req['서비스분야'] || '-'}</p>
                                </div>
                                <div>
                                    <span class="text-xs font-semibold text-gray-500 uppercase">서비스 중분류</span>
                                    <p class="text-sm text-gray-900 mt-1">${req['서비스중분류'] || '-'}</p>
                                </div>
                            </div>

                            <div class="mb-4">
                                <span class="text-xs font-semibold text-gray-500 uppercase">기능명</span>
                                <p class="text-base font-medium text-gray-900 mt-1">${req['기능명'] || '-'}</p>
                            </div>

                            ${getParentFunctionName(req) ? `
                                <div class="mb-4">
                                    <span class="text-xs font-semibold text-gray-500 uppercase">상위 요구사항 내용</span>
                                    <p class="text-sm text-gray-700 mt-1">${getParentFunctionName(req)}</p>
                                </div>
                            ` : ''}

                            <div class="mb-4">
                                <span class="text-xs font-semibold text-gray-500 uppercase">요구사항 내용</span>
                                <div class="mt-2 p-4 bg-gray-50 rounded-lg border border-gray-200">
                                    <pre class="text-sm text-gray-800 whitespace-pre-wrap font-sans">${req['요구사항내용'] || '-'}</pre>
                                </div>
                            </div>

                            ${req['산출정보'] ? `
                                <div>
                                    <span class="text-xs font-semibold text-gray-500 uppercase">산출정보</span>
                                    <p class="text-sm text-gray-700 mt-1">${req['산출정보']}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // HTML 이스케이프 함수
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 요구사항 수정
        function editRequirement(index) {
            if (lockedRequirements.has(index)) {
                alert('⚠️ 잠긴 요구사항은 수정할 수 없습니다. 먼저 잠금을 해제하세요.');
                return;
            }
            const req = requirements[index];

            // 모달 창 생성
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4">
                        <h2 class="text-2xl font-bold text-gray-900">요구사항 수정</h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">기능명</label>
                            <input type="text" id="edit-function-name" value="${escapeHtml(req['기능명'] || '')}"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">요구사항 내용</label>
                            <textarea id="edit-requirement-content" rows="8"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">${escapeHtml(req['요구사항내용'] || '')}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">산출정보</label>
                            <input type="text" id="edit-output-info" value="${escapeHtml(req['산출정보'] || '')}"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                        </div>
                    </div>
                    <div class="sticky bottom-0 bg-gray-50 px-6 py-4 flex justify-end gap-3 border-t border-gray-200">
                        <button onclick="closeEditModal()"
                            class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium">
                            취소
                        </button>
                        <button onclick="saveEditedRequirement(${index})"
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                            저장
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            modal.id = 'edit-modal';
        }

        // 수정 모달 닫기
        function closeEditModal() {
            const modal = document.getElementById('edit-modal');
            if (modal) {
                modal.remove();
            }
        }

        // 수정 내용 저장
        function saveEditedRequirement(index) {
            const functionName = document.getElementById('edit-function-name').value;
            const requirementContent = document.getElementById('edit-requirement-content').value;
            const outputInfo = document.getElementById('edit-output-info').value;

            requirements[index]['기능명'] = functionName;
            requirements[index]['요구사항내용'] = requirementContent;
            requirements[index]['산출정보'] = outputInfo;
            requirements[index]['비고'] = requirements[index]['비고'] === 'AI 자동 생성' ? 'AI 생성 (사용자 수정)' : '사용자 수정';

            closeEditModal();
            renderRequirements();
            alert('✅ 수정되었습니다!');
        }

        // 잠금/잠금해제
        function toggleLock(index) {
            if (lockedRequirements.has(index)) {
                lockedRequirements.delete(index);
            } else {
                lockedRequirements.add(index);
            }
            renderRequirements();
        }

        // 요구사항 삭제
        function deleteRequirement(index) {
            if (lockedRequirements.has(index)) {
                alert('⚠️ 잠긴 요구사항은 삭제할 수 없습니다. 먼저 잠금을 해제하세요.');
                return;
            }
            if (confirm('이 요구사항을 삭제하시겠습니까?')) {
                requirements.splice(index, 1);
                // 인덱스 재조정
                const newLockedRequirements = new Set();
                lockedRequirements.forEach(lockedIndex => {
                    if (lockedIndex < index) {
                        newLockedRequirements.add(lockedIndex);
                    } else if (lockedIndex > index) {
                        newLockedRequirements.add(lockedIndex - 1);
                    }
                });
                lockedRequirements = newLockedRequirements;
                renderRequirements();
                alert('✅ 삭제되었습니다!');
            }
        }

        // 새 요구사항 추가
        function addNewRequirement() {
            const newReq = {
                '기능ID': `F-NEW-${Date.now()}`,
                '상위기능ID': '',
                '서비스분야': '',
                '서비스중분류': '',
                '기능명': '새 요구사항',
                '상위요구사항내용': '',
                '요구사항분류': '기능요구사항(FR)',
                '요구사항내용': '',
                '산출정보': '',
                '비고': '사용자 추가'
            };
            requirements.push(newReq);
            renderRequirements();
            alert('✅ 새 요구사항이 추가되었습니다!');
        }

        // JSON 저장 (잠금 상태 포함)
        function exportToJSON() {
            const version = prompt('버전명을 입력하세요 (예: v1.0):', 'v1.0');
            if (!version) return;

            // 잠금 상태를 포함한 데이터 복사
            const dataWithLock = requirements.map((req, index) => ({
                ...req,
                locked: lockedRequirements.has(index)
            }));

            const jsonStr = JSON.stringify(dataWithLock, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${version}_RFP_요구사항_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert('✅ JSON 파일이 저장되었습니다! (잠금 상태 포함)');
        }

        // Excel 내보내기 (CSV)
        function exportToExcel() {
            const headers = ['기능ID', '상위기능ID', '서비스분야', '서비스중분류', '기능명', '상위요구사항내용',
                            '요구사항분류', '요구사항내용', '산출정보', '비고'];

            const rows = requirements.map(req => headers.map(h => {
                const value = req[h] || '';
                return `"${String(value).replace(/"/g, '""')}"`;
            }));

            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `RFP_요구사항_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            alert('✅ CSV 파일이 저장되었습니다!');
        }

        // 필터 초기화
        function resetFilters() {
            document.getElementById('filterFunctionId').value = '';
            document.getElementById('filterServiceArea').value = '';
            document.getElementById('filterServiceCategory').value = '';
            document.getElementById('filterReqType').value = '';
            document.getElementById('filterSearch').value = '';
            document.getElementById('showOnlyAI').checked = false;
            document.getElementById('showOnlyLocked').checked = false;
            document.getElementById('showOnlyUnlocked').checked = false;
            renderRequirements();
        }

        // 초기화
        window.addEventListener('DOMContentLoaded', () => {
            loadJsonFileList(); // JSON 파일 목록 먼저 로드
            loadDefaultData();
        });
    </script>
</body>
</html>
